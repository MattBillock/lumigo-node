!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var r=t();for(var n in r)("object"==typeof exports?exports:e)[n]=r[n]}}(global,function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var s=t[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,r),s.l=!0,s.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)r.d(n,s,function(t){return e[t]}.bind(null,s));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=6)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.safeExecute=t.omitKeys=t.shouldScrubDomain=t.parseQueryParams=t.getJSONBase64Size=t.getEdgeUrl=t.spanHasErrors=t.getEdgeHost=t.addHeaders=t.getAwsEdgeHost=t.httpReq=t.removeLumigoFromStacktrace=t.isAwsService=t.getRandomId=t.getRandomString=t.lowerCaseObjectKeys=t.parseErrorObject=t.pruneData=t.stringifyAndPrune=t.prune=t.getEventEntitySize=t.MAX_ENTITY_SIZE=t.isString=t.setDebug=t.setSwitchOff=t.setVerboseMode=t.setPruneTraceOff=t.setSendOnlyIfErrors=t.setWarm=t.isSwitchedOff=t.isPruneTraceOff=t.isSendOnlyIfErrors=t.isWarm=t.isVerboseMode=t.isAwsEnvironment=t.getAWSEnvironment=t.isPromise=t.getPatchedTraceId=t.getTraceId=t.getTracerInfo=t.getAccountId=t.getAccountIdFromInvokedFunctinArn=t.getContextInfo=t.LUMIGO_DEFAULT_DOMAIN_SCRUBBERS=t.LUMIGO_TRACER_EDGE=t.SPAN_PATH=void 0;var n=r(2),s=c(r(3)),o=c(r(8)),a=r(4),i=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var n=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,r):{};n.get||n.set?Object.defineProperty(t,r,n):t[r]=e[r]}return t.default=e,t}(r(1));function c(e){return e&&e.__esModule?e:{default:e}}t.SPAN_PATH="/api/spans";t.LUMIGO_TRACER_EDGE="lumigo-tracer-edge.golumigo.com";t.LUMIGO_DEFAULT_DOMAIN_SCRUBBERS='["secretsmanager.*.amazonaws.com", "ssm.*.amazonaws.com", "kms.*.amazonaws.com"]';t.getContextInfo=e=>{const t=e.getRemainingTimeInMillis(),{functionName:r,awsRequestId:n,invokedFunctionArn:s,callbackWaitsForEmptyEventLoop:o}=e;return{functionName:r,awsRequestId:n,awsAccountId:s?s.split(":")[4]:"",remainingTimeInMillis:t,callbackWaitsForEmptyEventLoop:o}};const u=e=>e?e.split(":")[4]:"";t.getAccountIdFromInvokedFunctinArn=u;t.getAccountId=e=>{const{invokedFunctionArn:t}=e;return u(t)};t.getTracerInfo=()=>{const e=r(9),{name:t,version:n}=e;return{name:t,version:n}};const d=e=>{if(!e)throw new Error("Missing _X_AMZN_TRACE_ID in Lambda Env Vars.");const t=e.split(";");if(3!==t.length)throw new Error("Expected 3 semi-colon separated parts in _X_AMZN_TRACE_ID.");const r={};if(t.forEach(e=>{const[t,n]=e.split("=");r[t]=n}),!r.Root||!r.Parent||!r.Sampled)throw new Error("Either Root, Parent or Sampled weren't found in traceId.");const n=r.Root.split("-")[2];return r.transactionId=n,r};t.getTraceId=d;t.getPatchedTraceId=e=>{const{Root:t,Parent:r,Sampled:n,transactionId:s}=d(e),o=t.split("-"),a=m(4);return`Root=${o[0]}-0000${a}-${s};Parent=${r};Sampled=${n}`};t.isPromise=e=>e&&e.then&&"function"==typeof e.then;const l=()=>{const{AWS_REGION:e,_X_AMZN_TRACE_ID:t,AWS_EXECUTION_ENV:r,LAMBDA_TASK_ROOT:n,LAMBDA_RUNTIME_DIR:s,AWS_LAMBDA_FUNCTION_NAME:o,AWS_LAMBDA_LOG_GROUP_NAME:a,AWS_LAMBDA_LOG_STREAM_NAME:i,AWS_LAMBDA_FUNCTION_VERSION:c,AWS_LAMBDA_FUNCTION_MEMORY_SIZE:u}=process.env;return{awsRegion:e,awsExecutionEnv:r,awsXAmznTraceId:t,awsLambdaTaskRoot:n,awsLambdaRuntimeDir:s,awsLambdaFunctionName:o,awsLambdaLogGroupName:a,awsLambdaLogStreamName:i,awsLambdaFunctionVersion:c,awsLambdaFunctionMemorySize:u}};t.getAWSEnvironment=l;t.isAwsEnvironment=()=>!!process.env.LAMBDA_RUNTIME_DIR;t.isVerboseMode=()=>!(!process.env.LUMIGO_VERBOSE||"TRUE"!==process.env.LUMIGO_VERBOSE);t.isWarm=()=>!(!process.env.LUMIGO_IS_WARM||"TRUE"!==process.env.LUMIGO_IS_WARM);t.isSendOnlyIfErrors=()=>!(!process.env.SEND_ONLY_IF_ERROR||"TRUE"!==process.env.SEND_ONLY_IF_ERROR);t.isPruneTraceOff=()=>!(!process.env.LUMIGO_PRUNE_TRACE_OFF||"TRUE"!==process.env.LUMIGO_PRUNE_TRACE_OFF);t.isSwitchedOff=()=>n.TracerGlobals.getTracerInputs().switchOff;t.setWarm=()=>process.env.LUMIGO_IS_WARM="TRUE";t.setSendOnlyIfErrors=()=>process.env.SEND_ONLY_IF_ERROR="TRUE";t.setPruneTraceOff=()=>process.env.LUMIGO_PRUNE_TRACE_OFF="TRUE";t.setVerboseMode=()=>process.env.LUMIGO_VERBOSE="TRUE";t.setSwitchOff=()=>process.env.LUMIGO_SWITCH_OFF="TRUE";t.setDebug=()=>process.env.LUMIGO_DEBUG="TRUE";const p=e=>"[object String]"===Object.prototype.toString.call(e);t.isString=p;t.MAX_ENTITY_SIZE=1024;t.getEventEntitySize=()=>parseInt(process.env.MAX_EVENT_ENTITY_SIZE)||1024;const f=(e,t=1024)=>e.substr(0,t);t.prune=f;const g=(e,t=1024)=>f(JSON.stringify(e),t);t.stringifyAndPrune=g;t.pruneData=(e,t)=>p(e)?f(e,t):g(e,t);t.parseErrorObject=e=>({type:e&&e.name,message:e&&e.message,stacktrace:e&&e.stack});t.lowerCaseObjectKeys=e=>e?Object.keys(e).reduce((t,r)=>(t[r.toLowerCase()]=e[r],t),{}):{};const m=e=>o.default.randomBytes(e/2).toString("hex").toLowerCase();t.getRandomString=m;t.getRandomId=()=>{return`${m(8)}-${m(4)}-${m(4)}-${m(4)}-${m(12)}`};t.isAwsService=(e,t)=>!(!e||!e.includes("amazonaws.com"))||!(!t||!t.headers||!t.headers["x-amzn-requestid"]&&!t.headers["x-amz-request-id"]);t.removeLumigoFromStacktrace=e=>{try{const{err:t,data:r,type:n}=e;if(!t||!t.stack)return e;const{stack:s}=t,o=s.split("\n"),a="/dist/lumigo.js:",c=(e,t,r)=>(t.includes(a)&&e.push(r),e),u=o.reduce(c,[]),d=u.shift(),l=u.pop()-d+1;return o.splice(d,l),t.stack=o.join("\n"),{err:t,data:r,type:n}}catch(t){return i.warn("Failed to remove Lumigo from stacktrace",t),e}};t.httpReq=(e={},t)=>new Promise((r,n)=>{const o=s.default.request(e,e=>{const{statusCode:t}=e;let n="";e.on("data",e=>n+=e),e.on("end",()=>r({statusCode:t,data:n}))});o.on("error",e=>n(e)),t&&o.write(t),o.end()});const h=()=>{const{awsRegion:e}=l();return`${e}.lumigo-tracer-edge.golumigo.com`};t.getAwsEdgeHost=h;t.addHeaders=(e,t)=>Object.assign({},e,t);const b=()=>{const{edgeHost:e}=n.TracerGlobals.getTracerInputs();return e||h()};t.getEdgeHost=b;t.spanHasErrors=e=>!!(e.error||e.info&&e.info.httpInfo&&e.info.httpInfo.response&&e.info.httpInfo.response.statusCode&&e.info.httpInfo.response.statusCode>400);t.getEdgeUrl=()=>{return{host:b(),path:"/api/spans"}};t.getJSONBase64Size=e=>Math.ceil(Buffer.byteLength(JSON.stringify(e),"utf8")/3*4);t.parseQueryParams=e=>{if("string"!=typeof e)return{};let t={};return e.replace(/([^=&]+)=([^&]*)/g,function(e,r,n){t[decodeURIComponent(r)]=decodeURIComponent(n)}),t};t.shouldScrubDomain=e=>!!e&&(()=>JSON.parse(process.env.LUMIGO_DOMAINS_SCRUBBER||'["secretsmanager.*.amazonaws.com", "ssm.*.amazonaws.com", "kms.*.amazonaws.com"]').map(e=>new RegExp(e,"i")))().some(t=>e.match(t));const y=e=>{if(e instanceof Array)return e.map(y);if("string"==typeof e)try{const t=JSON.parse(e);return"object"==typeof t?y(t):e}catch(t){return e}if(!e||"object"!=typeof e)return e;e=(0,a.noCirculars)(e);const t=(()=>JSON.parse(process.env.LUMIGO_BLACKLIST_REGEX||'[".*pass.*", ".*key.*" , ".*secret.*" ,  ".*credential.*" , ".*passphrase.*"]').map(e=>new RegExp(e,"i")))();return Object.keys(e).reduce((r,n)=>{let s=y(e[n]),o=t.some(e=>e.test(n));return r[n]=o?"****":s,r},{})};t.omitKeys=y;t.safeExecute=(e,t="Error in Lumigo tracer")=>()=>{try{return e()}catch(e){i.warn(t,e)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.warnClient=t.log=t.debug=t.fatal=t.warn=t.info=t.invokeLog=t.isDebug=void 0;var n=r(2);t.isDebug=()=>{return n.TracerGlobals.getTracerInputs().debug};t.invokeLog=e=>(r,n)=>t.isDebug()&&t.log(e,r,n);const s=t.invokeLog("INFO");t.info=s;const o=t.invokeLog("WARNING");t.warn=o;const a=t.invokeLog("FATAL");t.fatal=a;const i=t.invokeLog("DEBUG");t.debug=i;t.log=(e,t,r)=>{const n=`#LUMIGO# - ${e} - ${JSON.stringify(t,null,2)}`;if(r){const e=JSON.stringify(r,null,2);console.log(n,e)}else console.log(n)};t.warnClient=e=>"off"===process.env.LUMIGO_WARNINGS?(i("Does not warn the user about",e),!1):(console.log(`Lumigo Warning: ${e}`),!0)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.clearGlobals=t.TracerGlobals=t.SpansContainer=void 0;var n=r(1);const s=(()=>{const e=[];return{addSpan:t=>{e.push(t),(0,n.debug)("Span created",t)},getSpans:()=>e,clearSpans:()=>e.length=0}})();t.SpansContainer=s;const o=(()=>{const e={event:{},context:{}},t={token:"",debug:!1,edgeHost:"",switchOff:!1};return{getTracerInputs:()=>t,setTracerInputs:({token:e="",debug:r=!1,edgeHost:n="",switchOff:s=!1})=>Object.assign(t,{token:e||process.env.LUMIGO_TRACER_TOKEN,debug:r||!(!process.env.LUMIGO_DEBUG||"TRUE"!==process.env.LUMIGO_DEBUG.toUpperCase()),edgeHost:n||process.env.LUMIGO_TRACER_HOST,switchOff:s||!(!process.env.LUMIGO_SWITCH_OFF||"TRUE"!==process.env.LUMIGO_SWITCH_OFF)}),setHandlerInputs:({event:t,context:r})=>Object.assign(e,{event:t,context:r}),getHandlerInputs:()=>e,clearTracerInputs:()=>Object.assign(t,{token:"",debug:!1,edgeHost:"",switchOff:!1}),clearHandlerInputs:()=>Object.assign(e,{event:{},context:{}})}})();t.TracerGlobals=o;t.clearGlobals=()=>{s.clearSpans(),o.clearTracerInputs(),o.clearHandlerInputs()}},function(e,t){e.exports=require("https")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.noCirculars=void 0;t.noCirculars=e=>{const t=new Set,r=e=>Array.isArray(e)?e.map(r):"object"==typeof e&&null!==e?t.has(e)?"[Circular]":(t.add(e),function(e){return[...e].reduce((e,[t,r])=>(e[t]=r,e),{})}(Object.entries(e).map(([e,t])=>[e,r(t)]))):e;return r(e)}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.addRttToFunctionSpan=t.getHttpSpan=t.getHttpSpanTimings=t.getBasicHttpSpan=t.getHttpInfo=t.getAwsServiceData=t.getServiceType=t.getAwsServiceFromHost=t.AWS_PARSED_SERVICES=t.getEndFunctionSpan=t.removeStartedFromId=t.getFunctionSpan=t.getBasicSpan=t.getCurrentTransactionId=t.getSpanInfo=t.EXTERNAL_SERVICE=t.FUNCTION_SPAN=t.HTTP_SPAN=void 0;var n=r(0),s=r(10),o=r(2),a=r(12);t.HTTP_SPAN="http";t.FUNCTION_SPAN="function";t.EXTERNAL_SERVICE="external";const i=()=>{const e=(0,n.getTracerInfo)(),{awsLambdaLogGroupName:t,awsLambdaLogStreamName:r,awsXAmznTraceId:s}=(0,n.getAWSEnvironment)();return{traceId:(0,n.getTraceId)(s),tracer:e,logGroupName:t,logStreamName:r}};t.getSpanInfo=i;const c=()=>{const{event:e}=o.TracerGlobals.getHandlerInputs();return i().traceId.transactionId};t.getCurrentTransactionId=c;const u=()=>{const{event:e,context:t}=o.TracerGlobals.getHandlerInputs(),{token:r}=o.TracerGlobals.getTracerInputs(),s=i(),a=c(),u=(0,n.getAccountId)(t),{awsRegion:d,awsExecutionEnv:l,awsLambdaFunctionMemorySize:p,awsLambdaFunctionVersion:f}=(0,n.getAWSEnvironment)(),g=u,m=(0,n.isWarm)()?"warm":"cold";return"cold"===m&&(0,n.setWarm)(),{info:s,vendor:"AWS",transactionId:a,account:g,memoryAllocated:p,version:f,runtime:l,readiness:m,messageVersion:2,token:r,region:d}};t.getBasicSpan=u;t.getFunctionSpan=()=>{const{event:e,context:t}=o.TracerGlobals.getHandlerInputs(),r=u(),s={...r.info,...(0,a.getEventInfo)(e)},i=(new Date).getTime(),c=i,d=(0,n.stringifyAndPrune)((0,n.omitKeys)(e),(0,n.getEventEntitySize)()),l=(0,n.stringifyAndPrune)((0,n.omitKeys)(process.env)),{functionName:p,awsRequestId:f,remainingTimeInMillis:g}=(0,n.getContextInfo)(t),m=`${f}_started`,h=i+g;return{...r,info:s,id:m,envs:l,name:p,type:"function",ended:c,event:d,started:i,maxFinishTime:h}};const d=e=>e.split("_")[0];t.removeStartedFromId=d;t.getEndFunctionSpan=(e,t)=>{const{err:r,data:s}=t,o=d(e.id),a=r?(0,n.parseErrorObject)(r):void 0,i=(new Date).getTime(),c=s?(0,n.pruneData)((0,n.omitKeys)(s)):null;return Object.assign({},e,{id:o,ended:i,error:a,return_value:c})};const l=["dynamodb","sns","lambda","sqs","kinesis"];t.AWS_PARSED_SERVICES=l;const p=e=>{const t=e.split(".")[0];return l.includes(t)?t:"external"};t.getAwsServiceFromHost=p;const f=e=>(0,n.isAwsService)(e)?p(e):"external";t.getServiceType=f;const g=(e,t)=>{const{host:r}=e;switch(p(r)){case"dynamodb":return(0,s.dynamodbParser)(e,t);case"sns":return(0,s.snsParser)(e,t);case"lambda":return(0,s.lambdaParser)(e,t);case"sqs":return(0,s.sqsParser)(e,t);case"kinesis":return(0,s.kinesisParser)(e,t);default:return(0,s.awsParser)(e,t)}};t.getAwsServiceData=g;const m=(e,t)=>{const{host:r}=e,s=Object.assign({},e),o=Object.assign({},t);return(0,n.shouldScrubDomain)(r)||s.host&&(0,n.shouldScrubDomain)(s.host)||o.host&&(0,n.shouldScrubDomain)(o.host)?(s.body="The data is not available",o.body="The data is not available",delete s.headers,delete o.headers,delete s.uri):(s.headers=(0,n.stringifyAndPrune)((0,n.omitKeys)(s.headers)),s.body=(0,n.stringifyAndPrune)((0,n.omitKeys)(s.body)),o.headers=(0,n.stringifyAndPrune)((0,n.omitKeys)(o.headers)),o.body=(0,n.stringifyAndPrune)((0,n.omitKeys)(o.body))),{host:r,request:s,response:o}};t.getHttpInfo=m;const h=(e=null)=>{const{context:t}=o.TracerGlobals.getHandlerInputs(),{awsRequestId:r}=t,s=e||(0,n.getRandomId)();return{...u(),id:s,type:"http",parentId:r}};t.getBasicHttpSpan=h;const b=(e,t)=>{const{sendTime:r}=e,{receivedTime:n}=t;return{started:r,ended:n}};t.getHttpSpanTimings=b;t.getHttpSpan=(e,t)=>{const{host:r}=e,{awsServiceData:s,spanId:o}=(0,n.isAwsService)(r,t)?g(e,t):{},a=m(e,t),i=h(o),c=Object.assign({},i.info,{httpInfo:a,...s}),u=f(r),{started:d,ended:l}=b(e,t);return{...i,info:c,service:u,started:d,ended:l}};t.addRttToFunctionSpan=(e,t)=>Object.assign({},e,{reporter_rtt:t})},function(e,t,r){"use strict";var n=r(7),s=r(0);(0,r(1).debug)("Tracer imported"),e.exports=function({token:e,debug:t=!1,edgeHost:r,eventFilter:o={},verbose:a=!1,switchOff:i=!1}){return a&&(0,s.setVerboseMode)(),i&&(0,s.setSwitchOff)(),{trace:(0,n.trace)({token:e,debug:t,edgeHost:r,switchOff:i,eventFilter:o})}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.trace=t.promisifyUserHandler=t.callbackResolver=t.endTrace=t.isCallbacked=t.sendEndTraceSpans=t.startTrace=t.LEAK_MESSAGE=t.NON_ASYNC_HANDLER_ERRORED=t.ASYNC_HANDLER_REJECTED=t.ASYNC_HANDLER_RESOLVED=t.HANDLER_CALLBACKED=void 0;var n,s=r(0),o=r(5),a=r(13),i=r(2),c=(n=r(14))&&n.__esModule?n:{default:n},u=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var n=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,r):{};n.get||n.set?Object.defineProperty(t,r,n):t[r]=e[r]}return t.default=e,t}(r(1));t.HANDLER_CALLBACKED="handler_callbacked";t.ASYNC_HANDLER_RESOLVED="async_handler_resolved";t.ASYNC_HANDLER_REJECTED="async_handler_rejected";t.NON_ASYNC_HANDLER_ERRORED="non_async_errored";const d="Execution leak detected. More information is available in: https://docs.lumigo.io/docs/execution-leak-detected";t.LEAK_MESSAGE=d;const l=async()=>{try{if(!(0,s.isSwitchedOff)()&&(0,s.isAwsEnvironment)()){const e=i.TracerGlobals.getTracerInputs(),t=i.TracerGlobals.getHandlerInputs(),{host:r,path:n}=(0,s.getEdgeUrl)();u.debug("Tracer started",{tracerInputs:e,handlerInputs:t,host:r,path:n});const c=(0,o.getFunctionSpan)();if(u.debug("startTrace span created",c),(0,s.isSendOnlyIfErrors)())return u.debug("Skip sending start span because tracer in 'send only if error' mode ."),null;{const{rtt:e}=await(0,a.sendSingleSpan)(c);return(0,o.addRttToFunctionSpan)(c,e)}}return null}catch(e){return u.fatal("startTrace failure",e),null}};t.startTrace=l;const p=async(e,t)=>{const r=(0,o.getEndFunctionSpan)(e,t),n=[...i.SpansContainer.getSpans(),r],s=(0,o.getCurrentTransactionId)(),c=[],l=[];n.forEach(e=>{e.transactionId===s?c.push(e):l.push(e)}),await(0,a.sendSpans)(c),c.length!==n.length&&(u.warnClient(d),l.forEach(e=>u.debug("Leaked span: ",e))),u.debug("Tracer ended"),(0,i.clearGlobals)()};t.sendEndTraceSpans=p;t.isCallbacked=e=>{const{type:t}=e;return"handler_callbacked"===t};const f=async(e,t)=>{try{e&&!(0,s.isSwitchedOff)()&&(0,s.isAwsEnvironment)()&&await p(e,t)}catch(e){u.fatal("endTrace failure",e),(0,i.clearGlobals)()}};t.endTrace=f;const g=e=>(t,r)=>e({err:t,data:r,type:"handler_callbacked"});t.callbackResolver=g;const m=(e,t,r)=>new Promise(n=>{try{const o=e(t,r,g(n));(0,s.isPromise)(o)&&o.then(e=>n({err:null,data:e,type:"async_handler_resolved"})).catch(e=>n({err:e,data:null,type:"async_handler_rejected"}))}catch(e){n({err:e,data:null,type:"non_async_errored"})}});t.promisifyUserHandler=m;const h=(e,t,r,n)=>{switch(r){case"handler_callbacked":n(e,t);break;case"async_handler_resolved":return t;case"non_async_errored":case"async_handler_rejected":throw e}};t.trace=({token:e,debug:t,edgeHost:r,switchOff:n,eventFilter:o})=>a=>async(d,p,g)=>{try{i.TracerGlobals.setHandlerInputs({event:d,context:p}),i.TracerGlobals.setTracerInputs({token:e,debug:t,edgeHost:r,switchOff:n,eventFilter:o})}catch(E){u.fatal("Failed to start tracer",E)}if(p.__wrappedByLumigo){const{err:e,data:t,type:r}=await m(a,d,p);return h(e,t,r,g)}p.__wrappedByLumigo=!0,(0,s.safeExecute)(c.default)();const b=l(),y=m(a,d,p),[S,_]=await Promise.all([b,y]),v=(0,s.removeLumigoFromStacktrace)(_);await f(S,v);const{err:E,data:O,type:w}=v;return h(E,O,w,g)}},function(e,t){e.exports=require("crypto")},function(e){e.exports=JSON.parse('{"name":"@lumigo/tracer","version":"1.24.1","description":"Lumigo Tracer for Node.js v8.x / v10.x Runtimes","main":"dist/lumigo.js","repository":"git@github.com:lumigo-io/lumigo-node.git","private":false,"author":"Lumigo LTD (https://lumigo.io)","contributors":["Sagi Kedmi (https://sagi.io)"],"license":"Apache-2.0","scripts":{"build:babel":"babel --ignore \'**/*.test.js\' --ignore testdata src -d lib --verbose","build:webpack":"webpack --display-modules ./lib -o dist/lumigo.js","build":"npm run build:babel && npm run build:webpack","jest":"jest","semantic-release":"semantic-release","test":"npm run build && npm run jest","lint":"eslint ./src","prepublishOnly":"npm run prettier:fix && npm run lint && npm run test","prettier:ci":"prettier --list-different \\"src/**/*.js\\"","prettier:fix":"prettier --write \\"./src/**/*.js\\""},"devDependencies":{"@babel/cli":"^7.4.4","@babel/core":"^7.4.4","@babel/preset-env":"^7.4.4","@commitlint/cli":"^8.1.0","@commitlint/config-conventional":"^8.0.0","@semantic-release/changelog":"^3.0.4","@semantic-release/git":"^7.0.16","aws-sdk":"^2.465.0","babel-eslint":"^10.0.1","clone-response":"^1.0.2","codecov":"^3.5.0","eslint":"^5.16.0","eslint-config-prettier":"^4.3.0","eslint-plugin-jest":"^22.5.1","eslint-plugin-prettier":"^3.1.0","husky":"^2.4.1","jest":"^24.8.0","jest-junit":"^6.4.0","lambda-local":"^1.6.2","mockdate":"^2.0.2","node-fetch":"^2.6.0","prettier":"^1.17.1","semantic-release":"^15.13.19","shimmer":"^1.2.1","webpack":"^4.35.0","webpack-cli":"^3.3.4"},"release":{"branch":"master","plugins":["@semantic-release/commit-analyzer","@semantic-release/release-notes-generator","@semantic-release/npm","@semantic-release/git"]},"husky":{"hooks":{"commit-msg":"commitlint -E HUSKY_GIT_PARAMS"}}}')},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.awsParser=t.kinesisParser=t.sqsParser=t.snsParser=t.lambdaParser=t.dynamodbParser=void 0;var n,s=r(0),o=(n=r(11))&&n.__esModule?n:{default:n},a=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var n=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,r):{};n.get||n.set?Object.defineProperty(t,r,n):t[r]=e[r]}return t.default=e,t}(r(1));t.dynamodbParser=e=>{const{headers:t,body:r}=e,n=t["X-Amz-Target"]&&t["X-Amz-Target"].split(".")[1]||"",s=!!r&&JSON.parse(r)||{};return{awsServiceData:{resourceName:s.TableName&&s.TableName||"",dynamodbMethod:n}}};t.lambdaParser=(e,t)=>{const{path:r,headers:n}=e,s=r.split("/")[3],o=n["x-amz-invocation-type"],{headers:a}=t;return{awsServiceData:{resourceName:s,invocationType:o},spanId:a["x-amzn-requestid"]||a["x-amz-requestid"]||""}};t.snsParser=(e,t)=>{const{body:r}=e,{body:n}=t,a=r?(0,s.parseQueryParams)(r):void 0,i=n?(0,o.default)(n):void 0,c=a?a.TopicArn:void 0;return{awsServiceData:{resourceName:c,targetArn:c,messageId:i?((i.PublishResponse||{}).PublishResult||{}).MessageId:void 0}}};t.sqsParser=e=>{const{body:t}=e,r=t?(0,s.parseQueryParams)(t):void 0;return{awsServiceData:{resourceName:r?r.QueueUrl:void 0}}};t.kinesisParser=(e,t)=>{const{body:r}=e,{body:n}=t,s=!!r&&JSON.parse(r)||{};let o={};try{o=!!n&&JSON.parse(n)||{}}catch(e){a.info(`Unable to parse response, ${e}`),o={}}const i={resourceName:s.StreamName&&s.StreamName||void 0};return o.SequenceNumber&&(i.messageId=o.SequenceNumber),Array.isArray(o.Records)&&(i.messageIds=o.Records.map(e=>e.SequenceNumber).filter(e=>!!e)),{awsServiceData:i}};t.awsParser=(e,t)=>{const{headers:r}=t,n=r?r["x-amzn-requestid"]||r["x-amz-request-id"]:void 0;return n?{awsServiceData:{messageId:n}}:{}}},function(e,t,r){"use strict";e.exports=function e(t,r){t=n(t);const c=new RegExp("<(.*?)[>|\\s|/]","g");const u={};let d=!1;if(""===t||"<"!==t.charAt(0)&&">"!==t.charAt(t.length-1))return t;var l;var p=0;for(;null!==(l=c.exec(t));){let t=!1;const n=l[1],f="</"+n+">",g=l.input,m=g.indexOf(">",p)+1,h=l.index,b=l.input.indexOf(">",h)+1,y=l.input.substring(h,b);if(t=s(y),!a(y)){const e=new Error("Invalid XML tag");throw e}const S=i(g,f,m);if(!1===t&&S<0)return{};let _;t?(_="",p=y.length+p):(_=g.substring(g.indexOf(">",p)+1,S),p=m+_.length+f.length),c.lastIndex=p,u[n]?d=!0:u[n]={};let v,E={};if(r&&(v=o(y)),d&&r)E=v;else if(!d&&r)for(let e in v)u[n][e]=v[e];const O=e(_,r);if("object"==typeof O)if(d&&!u[n].length){const e=u[n];u[n]=[e];const t={};for(let e in O)t[e]=O[e];E={...E,...t},u[n].push(E)}else if(d){const e={};for(let t in O)e[t]=O[t];E={...E,...e},u[n].push(E)}else for(let e in O)u[n][e]=O[e];else if(Object.keys(u[n]).length>0)if(d&&!u[n].length||"string"==typeof u[n]){const e=u[n];u[n]=[e],"object"!=typeof O?0===Object.keys(E).length?u[n].push(O):(""!==O&&(E.textNode=O),u[n].push(E)):(E={...E,next:O},u[n].push(O))}else d?"object"!=typeof O?0===Object.keys(E).length?u[n].push(O):(""!==O&&(E.textNode=O),u[n].push(E)):(E={...E,next:O},u[n].push(O)):""!==O&&(u[n]={...u[n],textNode:O});else if(d&&"object"!=typeof u[n]){const e=u[n];u[n]=[],u[n].push(...e,O)}else u[n]=O}return u};const n=function(e){return e.replace(/>\s*</g,"><").replace(/<\?xml.*\?>/g,"").replace(/<!--.*-->/g,"").replace(/>\s*/g,">").replace(/\s*</g,"<")};function s(e){return e.indexOf("/>")>-1}function o(e){const t=new RegExp('(\\S*)="(.*?)"',"g"),r={};let n;for(;null!==(n=t.exec(e));){const e=n[1],t=n[2];r[e]=t}return r}function a(e){return"<"===e.charAt(0)&&"?"===e.charAt(1)&&">"===e.charAt(e.length-1)&&"?"===e.charAt(e.length-2)||"<"===e.charAt(0)&&(e.charAt(e.length-2)+e.charAt(e.length-1)==="/>"||">"===e.charAt(e.length-1))}function i(e,t,r){const n=t.replace("</","<").replace(">","");let s=e.indexOf(t,r),o=e.indexOf(n,r);if(s<o)return s;if(!e.substr(o,s-o).match(new RegExp(n+"\\W")))return s;for(;s>0;){const r=e.indexOf(t,s+1);if(!(r>0))break;s=r}return s}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getEventInfo=t.getRelevantEventData=t.getKinesisData=t.getSnsData=t.getApiGatewayData=t.getTriggeredBy=void 0;const n=e=>{if(e&&e.Records){const{eventSource:t,EventSource:r}=e.Records[0],n=t||r;if(n){const[e,t]=n.split(":");return t}}return e&&e.httpMethod?"apigw":"invocation"};t.getTriggeredBy=n;const s=e=>{const{headers:t={},resource:r,httpMethod:n,requestContext:s={}}=e,{stage:o=null}=s,a=t.Host||null;return{messageId:s.requestId,httpMethod:n,resource:r,stage:o,api:a}};t.getApiGatewayData=s;const o=e=>{const{TopicArn:t,MessageId:r}=e.Records[0].Sns;return{arn:t,messageId:r}};t.getSnsData=o;const a=e=>{return{arn:e.Records[0].eventSourceARN,messageIds:(e.Records||[]).map(e=>(e.kinesis||{}).sequenceNumber).filter(e=>!!e)}};t.getKinesisData=a;const i=(e,t)=>{switch(e){case"sqs":case"dynamodb":return{arn:t.Records[0].eventSourceARN};case"kinesis":return a(t);case"sns":return o(t);case"s3":return{arn:t.Records[0].s3.bucket.arn};case"apigw":return s(t);case"invocation":default:return{}}};t.getRelevantEventData=i;t.getEventInfo=e=>{const t=n(e);return{...i(t,e),triggeredBy:t}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.forgeRequestBody=t.sendSpans=t.isSpansContainsErrors=t.logSpans=t.sendSingleSpan=t.MAX_SENT_BYTES=void 0;var n=r(2),s=r(0),o=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var n=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,r):{};n.get||n.set?Object.defineProperty(t,r,n):t[r]=e[r]}return t.default=e,t}(r(1));t.MAX_SENT_BYTES=1e6;t.sendSingleSpan=async e=>t.sendSpans([e]);const a=e=>e.map(e=>o.debug("Span sent",e.id));t.logSpans=a;const i=e=>{return e.filter(e=>void 0!==e.error||(e=>(e.returnValue||{}).statusCode||0)(e)>400).length>0};t.isSpansContainsErrors=i;t.sendSpans=async e=>{const{token:t}=n.TracerGlobals.getTracerInputs(),{name:r,version:u}=(0,s.getTracerInfo)(),d={Authorization:t,"User-Agent":`${r}$${u}`,"Content-Type":"application/json"};if((0,s.isSendOnlyIfErrors)()&&!i(e))return o.debug("No Spans was sent, `SEND_ONLY_IF_ERROR` is on and no span has error"),{rtt:0};const{host:l,path:p}=(0,s.getEdgeUrl)();o.debug("Edge selected",{host:l,path:p});const f=c(e),g=Date.now();f&&await(0,s.httpReq)({method:"POST",headers:d,host:l,path:p},f);const m=Date.now()-g;return(0,o.isDebug)()&&a(e),{rtt:m}};const c=(e,t=1e6)=>{let r=[];if(e=e.map(s.omitKeys),(0,s.isPruneTraceOff)()||(0,s.getJSONBase64Size)(e)<=t)return e.length>0?JSON.stringify(e):void 0;o.debug("Starting trim spans before send");const n=e[e.length-1],a=[...e.filter(e=>(0,s.spanHasErrors)(e)&&e!==n),...e.filter(e=>!(0,s.spanHasErrors)(e)&&e!==n)];for(let e of a){(0,s.getJSONBase64Size)(r)+(0,s.getJSONBase64Size)(n)+(0,s.getJSONBase64Size)(e)<t&&r.push(e)}return r.push(n),e.length-r.length>0&&console.log("#LUMIGO# - Trimmed spans due to size"),r.length>0?JSON.stringify(r):void 0};t.forgeRequestBody=c},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n,s=(n=r(15))&&n.__esModule?n:{default:n},o=r(0);t.default=()=>{!(0,o.isSwitchedOff)()&&(0,o.isAwsEnvironment)()&&(0,s.default)()}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=t.httpGetWrapper=t.httpRequestWrapper=t.isAlreadyTraced=t.getHookedClientRequestArgs=t.httpRequestArguments=t.httpRequestOnWrapper=t.httpRequestEndWrapper=t.wrappedHttpResponseCallback=t.parseHttpRequestOptions=t.getHostFromOptionsOrUrl=t.isBlacklisted=t.hostBlaclist=void 0;var n=f(r(16)),s=f(r(17)),o=f(r(3)),a=r(2),i=r(0),c=r(5),u=f(r(18)),d=r(21),l=r(4),p=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var n=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,r):{};n.get||n.set?Object.defineProperty(t,r,n):t[r]=e[r]}return t.default=e,t}(r(1));function f(e){return e&&e.__esModule?e:{default:e}}const g=new Set(["127.0.0.1"]);t.hostBlaclist=g;const m=e=>e===(0,i.getEdgeHost)()||g.has(e);t.isBlacklisted=m;const h=(e,t)=>t?new d.URL(t).hostname:e.hostname||e.host||e.uri&&e.uri.hostname||"localhost";t.getHostFromOptionsOrUrl=h;const b=(e={},t)=>{const r=h(e,t),n=e.agent||e._defaultAgent;let s=null,o=null,a=null,{headers:c,method:u="GET"}=e;const l=(new Date).getTime();if(t){const e=new d.URL(t);({pathname:s,port:o,protocol:a}=e)}else s=e.path||"/",o=e.port||e.defaultPort||n&&n.defaultPort||80,a=e.protocol||443===o&&"https:"||"http:";return c&&!c.host&&(c=(0,i.addHeaders)(c,{host:r})),{path:s,port:o,uri:`${r}${s}`,host:r,body:"",method:u,headers:(0,i.lowerCaseObjectKeys)(c),protocol:a,sendTime:l}};t.parseHttpRequestOptions=b;t.wrappedHttpResponseCallback=(e,t)=>r=>{const n=(0,u.default)(r),s=(0,u.default)(r);try{const{headers:t,statusCode:r}=n,s=(new Date).getTime();let o="";n.on("data",e=>o+=e);let u={};n.on("end",(0,i.safeExecute)(()=>{u={statusCode:r,receivedTime:s,body:o,headers:(0,i.lowerCaseObjectKeys)(t)};const n=(0,l.noCirculars)(e),d=(0,l.noCirculars)(u),p=(0,c.getHttpSpan)(n,d);a.SpansContainer.addSpan(p)}))}catch(e){p.warn("Failed at wrappedHttpResponseCallback")}t&&t(s)};const y=e=>t=>(function(r,n,s){return r&&(e.body+=r),t.apply(this,[r,n,s])});t.httpRequestEndWrapper=y;const S=e=>r=>(function(n,s){let o=s;if("response"===n&&s&&!s.__lumigoSentinel)try{(o=t.wrappedHttpResponseCallback(e,s)).__lumigoSentinel=!0}catch(e){p.warn("Failed at wrapping with wrappedHttpResponseCallback",e)}return r.apply(this,[n,o])});t.httpRequestOnWrapper=S;const _=e=>{if(0===e.length)throw new Error("http/s.request(...) was called without any arguments.");let t=void 0,r=void 0,n=void 0;return"string"==typeof e[0]?(t=e[0],e[1]&&("function"==typeof e[1]?n=e[1]:r=e[1],"function"==typeof e[2]&&(n=e[2]))):(r=e[0],"function"==typeof e[1]&&(n=e[1])),{url:t,options:r,callback:n}};t.httpRequestArguments=_;const v=(e,r,n,s)=>{const o=[];if(e&&o.push(e),r&&o.push(r),n){const e=t.wrappedHttpResponseCallback(s,n);e.__lumigoSentinel=!0,o.push(e)}return o};t.getHookedClientRequestArgs=v;const E=e=>e&&e.__lumigoSentinel;t.isAlreadyTraced=E;const O=e=>(function(...t){let r,s,o,a,c=!0;try{({url:r,options:s,callback:o}=_(t)),a=h(s,r),c=m(a)||E(o)}catch(e){p.warn("request parsing error",e)}if(c)return e.apply(this,t);try{const c=s.headers;if(p.debug("Starting hook",{host:a,url:r,headers:c}),(0,i.isAwsService)(a)){const{awsXAmznTraceId:e}=(0,i.getAWSEnvironment)(),t=(0,i.getPatchedTraceId)(e);s.headers["X-Amzn-Trace-Id"]=t}const u=b(s,r),d=v(r,s,o,u),l=e.apply(this,d);return n.default.wrap(l,"end",y(u)),o||n.default.wrap(l,"on",S(u)),l}catch(r){return p.info("hook error",r),e.apply(this,t)}});t.httpRequestWrapper=O;const w=e=>()=>(function(...t){const r=e.request(...t);return r.end(),r});t.httpGetWrapper=w;t.default=()=>{n.default.wrap(s.default,"get",w(s.default)),n.default.wrap(o.default,"get",w(o.default)),n.default.wrap(s.default,"request",O),n.default.wrap(o.default,"request",O)}},function(e,t,r){"use strict";function n(e){return"function"==typeof e}var s=console.error.bind(console);function o(e,t,r){var n=!!e[t]&&e.propertyIsEnumerable(t);Object.defineProperty(e,t,{configurable:!0,enumerable:n,writable:!0,value:r})}function a(e){e&&e.logger&&(n(e.logger)?s=e.logger:s("new logger isn't a function, not replacing"))}function i(e,t,r){if(e&&e[t]){if(!r)return s("no wrapper function"),void s((new Error).stack);if(n(e[t])&&n(r)){var a=e[t],i=r(a,t);return o(i,"__original",a),o(i,"__unwrap",function(){e[t]===i&&o(e,t,a)}),o(i,"__wrapped",!0),o(e,t,i),i}s("original object and wrapper must be functions")}else s("no original function "+t+" to wrap")}function c(e,t){return e&&e[t]?e[t].__unwrap?e[t].__unwrap():void s("no original to unwrap to -- has "+t+" already been unwrapped?"):(s("no function to unwrap."),void s((new Error).stack))}a.wrap=i,a.massWrap=function(e,t,r){if(!e)return s("must provide one or more modules to patch"),void s((new Error).stack);Array.isArray(e)||(e=[e]),t&&Array.isArray(t)?e.forEach(function(e){t.forEach(function(t){i(e,t,r)})}):s("must provide one or more functions to wrap on modules")},a.unwrap=c,a.massUnwrap=function(e,t){if(!e)return s("must provide one or more modules to patch"),void s((new Error).stack);Array.isArray(e)||(e=[e]),t&&Array.isArray(t)?e.forEach(function(e){t.forEach(function(t){c(e,t)})}):s("must provide one or more functions to unwrap on modules")},e.exports=a},function(e,t){e.exports=require("http")},function(e,t,r){"use strict";const n=r(19).PassThrough,s=r(20);e.exports=e=>{if(!e||!e.pipe)throw new TypeError("Parameter `response` must be a response stream.");const t=new n;return s(e,t),e.pipe(t)}},function(e,t){e.exports=require("stream")},function(e,t,r){"use strict";const n=["destroy","setTimeout","socket","headers","trailers","rawHeaders","statusCode","httpVersion","httpVersionMinor","httpVersionMajor","rawTrailers","statusMessage"];e.exports=(e,t)=>{const r=new Set(Object.keys(e).concat(n));for(const n of r)n in t||(t[n]="function"==typeof e[n]?e[n].bind(e):e[n])}},function(e,t){e.exports=require("url")}])});